<!--
Requirements for Backend to make this page work (EN):
1. The backend must pass a 'user' object to the template (with user.role).
2. A GET endpoint at /api/classes must return a list of courses relevant to the user.
   - Each course must include: id, name, code, (optional) professor_name
3. The template dynamically fetches courses and renders them based on user.role.
4. Admin must be able to create and delete courses via form/POST to server.
 
Anforderungen an das Backend, damit diese Seite funktioniert (DE):
1. Das Backend muss ein 'user'-Objekt mit user.role übergeben.
2. Ein GET-Endpunkt /api/classes muss die Kurse für den Benutzer zurückgeben:
   - id, name, code, (optional) professor_name
3. Das Template lädt die Kurse per JavaScript und zeigt sie rollenabhängig an.
4. Admin darf Kurse hinzufügen (Formular) und löschen (POST).
-->
 
{% extends "base.html" %}
 
{% block title %}
{% if user.role == 'ADMIN' %}
Kurse verwalten – Admin
{% elif user.role == 'PROFESSOR' %}
Meine Kurse – Professor:innenansicht
{% else %}
Meine Kurse – Vorlesungschatbot
{% endif %}
{% endblock %}
 
{% block content %}
<div class="dashboard-container">
 
<!-- Überschrift und Admin-Navigation -->
{% if user.role == 'ADMIN' %}
<h1>Kurse verwalten</h1>
<div class="btn-group" style="margin-bottom: 1rem;">
<a href="/admin/dashboard" class="btn btn-secondary">Zurück zum Dashboard</a>
<a href="/admin/professors" class="btn btn-outline-primary">Professor:innen</a>
<a href="/admin/students" class="btn btn-outline-primary">Studierende</a>
<a href="/admin/chathistory" class="btn btn-outline-primary">Chathistorie</a>
</div>
 
<!-- Formular zum Hinzufügen eines neuen Kurses -->
<form id="add-class-form" class="form-inline" method="POST">
<h2>Neuen Kurs erstellen</h2>
<input type="text" name="name" placeholder="Kursname (z. B. Datenbanken)" required>
<input type="text" name="code" placeholder="Kurs-ID (z. B. WI123)" required>
<button type="submit" class="btn btn-primary">Kurs hinzufügen</button>
</form>
 
{% if success %}
<div class="success-message">{{ success }}</div>
{% endif %}
{% if error %}
<div class="error-message">{{ error }}</div>
{% endif %}
 
{% elif user.role == 'PROFESSOR' %}
<h1>Meine betreuten Kurse</h1>
{% else %}
<h1>Meine Kurse</h1>
{% endif %}
 
<!-- Kursliste dynamisch -->
<div id="course-list" class="course-list">
<!-- Wird durch JavaScript befüllt -->
</div>
 
<!-- Fallback-Text, wenn keine Kurse -->
<p id="no-courses-message" style="display: none;">
    {% if user.role == 'STUDENT' %}
    Du bist aktuell in keinen Kurs eingeschrieben.<br>
    Bitte kontaktiere deinen Dozenten oder Administrator.
    {% elif user.role == 'PROFESSOR' %}
    Aktuell betreuen Sie noch keine Kurse.<br>
    Bitte wenden Sie sich an den Admin, um Kurse zugewiesen zu bekommen.
    {% else %}
    Es sind derzeit keine Kurse im System.
    {% endif %}
</p>
 
</div>
{% endblock %}
 
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', async function () {
        const courseList = document.getElementById('course-list');
        const noCoursesMessage = document.getElementById('no-courses-message');
 
        try {
            const response = await fetch('/api/classes');
            const data = await response.json();
 
            if (!data.classes || data.classes.length === 0) {
                noCoursesMessage.style.display = 'block';
                return;
            }
 
            data.classes.forEach(course => {
                const card = document.createElement('div');
                card.classList.add('course-card');
 
                const title = document.createElement('h3');
                title.textContent = course.name;
 
                const code = document.createElement('p');
                code.textContent = 'Kurs-ID: ' + course.code;
 
                card.appendChild(title);
                card.appendChild(code);
 
                {% if user.role == 'ADMIN' %}
                const professor = document.createElement('p');
                professor.textContent = 'Dozent: ' + (course.professor_name || 'Nicht zugewiesen');
                card.appendChild(professor);
                {% endif %}
 
                const btnGroup = document.createElement('div');
                btnGroup.classList.add('btn-group');
 
                {% if user.role == 'STUDENT' %}
                const chatBtn = document.createElement('a');
                chatBtn.href = `/student/chat/${course.id}`;
                chatBtn.className = 'btn btn-primary';
                chatBtn.textContent = 'Zum Chat';
                btnGroup.appendChild(chatBtn);
                {% elif user.role == 'PROFESSOR' %}
                const pdfBtn = document.createElement('a');
                pdfBtn.href = `/professor/pdf/${course.id}`;
                pdfBtn.className = 'btn btn-secondary';
                pdfBtn.textContent = 'PDF-Übersicht';
 
                const chatBtn = document.createElement('a');
                chatBtn.href = `/professor/chat/${course.id}`;
                chatBtn.className = 'btn btn-primary';
                chatBtn.textContent = 'Zum Chat';
 
                btnGroup.appendChild(pdfBtn);
                btnGroup.appendChild(chatBtn);
                {% elif user.role == 'ADMIN' %}
                const pdfBtn = document.createElement('a');
                pdfBtn.href = `/admin/pdf/${course.id}`;
                pdfBtn.className = 'btn btn-secondary';
                pdfBtn.textContent = 'PDF-Übersicht';
 
                const chatBtn = document.createElement('a');
                chatBtn.href = `/admin/chat/${course.id}`;
                chatBtn.className = 'btn btn-primary';
                chatBtn.textContent = 'Zum Chat';
 
                const deleteForm = document.createElement('form');
                deleteForm.method = 'POST';
                deleteForm.action = `/admin/classes/delete/${course.id}`;
                deleteForm.style.display = 'inline-block';
                deleteForm.onsubmit = () => confirm('Diesen Kurs wirklich löschen?');
 
                const deleteBtn = document.createElement('button');
                deleteBtn.type = 'submit';
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'Löschen';
 
                deleteForm.appendChild(deleteBtn);
 
                btnGroup.appendChild(pdfBtn);
                btnGroup.appendChild(chatBtn);
                btnGroup.appendChild(deleteForm);
                {% endif %}
 
                card.appendChild(btnGroup);
                courseList.appendChild(card);
            });
 
        } catch (error) {
            console.error('Fehler beim Laden der Kurse:', error);
            noCoursesMessage.style.display = 'block';
        }
    });
</script>
{% endblock %}